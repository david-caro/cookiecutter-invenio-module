{% include 'misc/header.py' %}
[tox]
envlist =
    pep8, docstyle, docs, doctests, packaging,
{%- for python in cookiecutter.python_versions.split(',') %}
    {%- for database in cookiecutter.databases.split(',') %}
        {%- if database == 'sqlite' %}
    {{python}}
        {%- else %}
    {{python}}{{database}}
        {%- endif %}
    {%- endfor %}
{%- endfor %}
skip_missing_interpreters = true

[testenv]
setenv =
    # This is required in order to get UTF-8 output inside of the subprocesses
    # that our tests use.
    LC_CTYPE = en_US.UTF-8
{%- for python in cookiecutter.python_versions.split(',') %}
    {%- for database in cookiecutter.databases.split(',') %}
        {%- if database == 'sqlite' %}
    {{python}}: SQLALCHEMY_DATABASE_URI={env:SQLALCHEMY_DATABASE_URI:sqlite:///test.db}
        {%- elif database == 'mysql' %}
    {{python}}mysql: SQLALCHEMY_DATABASE_URI={env:SQLALCHEMY_DATABASE_URI:mysql+pymysql://localhost/workflows}
        {%- elif database == 'postgres' %}
    {{python}}postgres: SQLALCHEMY_DATABASE_URI={env:SQLALCHEMY_DATABASE_URI:postgresql+psycopg2://localhost/workflows}
        {%- endif %}
    {%- endfor %}
{%- endfor %}

commands =
    find {toxinidir} -type f -name "*.pyc" -delete
    py.test \
        --pep8 \
        --cov={envsitepackagesdir}/{{ cookiecutter.package_name }} \
        --cov-report=term-missing \
        tests \
        []

deps =
    -r{toxinidir}/test-requirements.txt
{%- for python in cookiecutter.python_versions.split(',') %}
    {%- for database in cookiecutter.databases.split(',') %}
        {%- if database == 'mysql' %}
    {{python}}mysql: pymysql
        {%- elif database == 'postgres' %}
    {{python}}postgres: psycopg2
        {%- endif %}
    {%- endfor %}
{%- endfor %}
    {docs,docstyle,doctests}: Sphinx==1.4.1

basepython =
    {pep8,docstyle,docs,doctests,packaging}: python2.7
{%- for python in cookiecutter.python_versions.split(',') %}
    {%- for database in cookiecutter.databases.split(',') %}
        {%- if database == 'sqlite' %}
    {{python}}: python{{ python[2] ~ '.' ~ python[3] }}
        {%- else %}
    {{python}}{{database}}: python{{ python[2] ~ '.' ~ python[3] }}
        {%- endif %}
    {%- endfor %}
{%- endfor %}

passenv =
    SQLALCHEMY*

whitelist_externals = find

[flake8]
exclude = .tox,*.egg,build,_vendor,data,docs
select = E,W,F

[testenv:docstyle]
commands = pydocstyle {{ cookiecutter.package_name }}

[testenv:docs]
commands = sphinx-build -qnNW docs docs/_build/html

[testenv:doctests]
commands = sphinx-build -qnNW -b doctest docs docs/_build/doctest

[testenv:packaging]
commands = check-manifest --ignore ".travis-*"

[testenv:pep8]
deps = flake8
commands = flake8 .
